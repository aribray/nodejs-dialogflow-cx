// Copyright 2022 Google LLC
//
// Licensed under the Apache License, Version 2.0 (the "License");
// you may not use this file except in compliance with the License.
// You may obtain a copy of the License at
//
//     https://www.apache.org/licenses/LICENSE-2.0
//
// Unless required by applicable law or agreed to in writing, software
// distributed under the License is distributed on an "AS IS" BASIS,
// WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
// See the License for the specific language governing permissions and
// limitations under the License.
//
// ** This file is automatically generated by gapic-generator-typescript. **
// ** https://github.com/googleapis/gapic-generator-typescript **
// ** All changes to this file may be overwritten. **

'use strict';

const axios = require('axios');

function main(country, projectId, agent) {
  // [START dialogflow_v3beta1_webhook_validate_form_parameters_async]
  /*
    TODO(developer): Uncomment these variables before running the sample.
    const country = 'your-country-parameter;
    const projectId = 'your-project-id'
    const agent = 'path-to-your-agent';
  */

  /*
    This sample assumes that you have exported the example agent located at https://storage.googleapis.com/cloud-samples-data/dialogflow-cx/country-info-agent.blob
    For more information on how to export and restore an agent, visit https://cloud.google.com/dialogflow/cx/docs/concept/agent?hl=en#export
    ** Retrieving the Agent ID **
    - In the console (on the page on which all of your project's agents are listed), the Agent ID can be retrieved by clicking the 3-dot menu next to the agent
      and selecting "Copy Name".
    - The Agent ID can be retrieved from your browser's URL when you access the agent in the console.
    - The Agent ID can also be retrieved by using the `projects.locations.agents.list` method in the API.
  */

  const webhookRequest = {
    fulfillmentInfo: {
      tag: 'validate-country',
    },
    sessionInfo: {
      parameters: {
        country: country,
      },
    },
  };

  async function validateParameter() {
    await axios({
      method: 'POST',
      url: `https://us-central1-${projectId}.cloudfunctions.net/validateParams`,
      data: {
        agent: agent,
        webhookRequest,
      },
    }).then(res => {
      const fulfillmentResponseMessage =
        res.data.fulfillmentResponse.messages[0].text.text[0];
      const parameterInfoState =
        res.data.pageInfo.formInfo.parameterInfo[0].state;

      console.log('Fulfillment Response:');
      console.log(fulfillmentResponseMessage, '\n');

      console.log('Parameter Status:');
      console.log(parameterInfoState, '\n'); // Parameter state: VALID or INVALID
      // response.send(res.data.fulfillmentResponse.messages[0].text.text[0]); TODO: should I 'send' webhook response?
    });
  }
  // [END dialogflow_v3beta1_webhook_validate_form_parameters_async]

  validateParameter();
}

process.on('unhandledRejection', err => {
  console.error(err.message);
  process.exitCode = 1;
});

main(...process.argv.slice(2));
